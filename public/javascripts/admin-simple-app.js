// Generated by CoffeeScript 1.10.0
(function($, _, EJS) {
  window.adminSimpleApp = (function() {
    function adminSimpleApp() {}

    adminSimpleApp.ws = null;

    adminSimpleApp.wsUrl = "ws://localhost:4000/backend/images";

    adminSimpleApp.timeoutId = null;

    adminSimpleApp.reconnectDelay = 5000;

    adminSimpleApp.imagesOnPage = 10;

    adminSimpleApp.$container = null;

    adminSimpleApp.ui = {
      container: '#images-list',
      item: '.media',
      warning: '#connection-warning'
    };

    adminSimpleApp.templates = {
      imageItem: '/javascripts/templates/image_item.ejs'
    };

    adminSimpleApp.init = function() {
      this.prepareTemplates();
      this.initView();
      return this.createWs();
    };

    adminSimpleApp.prepareTemplates = function() {
      return _.each(this.templates, function(url, key) {
        return this.templates[key] = new EJS({
          url: url
        });
      }, this);
    };

    adminSimpleApp.createWs = function() {
      var self;
      self = this;
      delete this.ws;
      this.ws = new WebSocket(this.wsUrl);
      this.ws.onopen = function() {
        return self.onWsOpen();
      };
      this.ws.onmessage = function(e) {
        return self.onWsMessage(e);
      };
      this.ws.onclose = function() {
        return self.onWsClose();
      };
      return this.ws.onerror = function(err) {};
    };

    adminSimpleApp.onWsOpen = function() {
      console.log("Successfully connect!");
      this.stopTryReconnect();
      return this.loadInitialData();
    };

    adminSimpleApp.onWsMessage = function(e) {
      var error, error1, messageOjb;
      try {
        messageOjb = JSON.parse(e.data);
        return this.processMessage(messageOjb);
      } catch (error1) {
        error = error1;
        return console.log(error);
      }
    };

    adminSimpleApp.onWsClose = function() {
      console.log("Connection closed!");
      return this.startTryReconnect();
    };

    adminSimpleApp.tryReconnect = function() {
      console.log("Trying to reconnect to WS at " + this.wsUrl);
      return this.createWs();
    };

    adminSimpleApp.startTryReconnect = function() {
      var self;
      this.$warning.show();
      console.log("Trying to reconnect to WS through " + this.reconnectDelay + " ms");
      self = this;
      return this.timeoutId = setTimeout(function() {
        return self.tryReconnect();
      }, this.reconnectDelay);
    };

    adminSimpleApp.stopTryReconnect = function() {
      this.$warning.hide();
      return clearTimeout(this.timeoutId);
    };

    adminSimpleApp.loadInitialData = function() {
      var action, self;
      action = 'get_list';
      self = this;
      return setTimeout(function() {
        console.log('ТУТ пашет');
        return self.ws.send(action);
      }, 100);
    };

    adminSimpleApp.processMessage = function(messageOjb) {
      console.log(messageOjb);
      switch (messageOjb.action) {
        case 'upload':
          return this.processNewPhoto(messageOjb.record);
        case 'list':
          return this.processNewPhotos(messageOjb.records);
      }
    };

    adminSimpleApp.processNewPhotos = function(images) {
      this.$container.empty();
      return _.each(images.reverse(), function(image) {
        return this.processNewPhoto(image);
      }, this);
    };

    adminSimpleApp.processNewPhoto = function(image) {
      var $newItem;
      $newItem = $(this.templates.imageItem.render({
        image: image
      }));
      $newItem.hide();
      this.$container.prepend($newItem);
      $newItem.slideDown('slow');
      return this.updateContainer();
    };

    adminSimpleApp.updateContainer = function() {
      return $(this.ui.item + ":gt(" + (this.imagesOnPage - 1) + ")", this.$container).slideUp("slow", function() {
        return $(this).remove();
      });
    };

    adminSimpleApp.initView = function() {
      this.$container = $(this.ui.container);
      return this.$warning = $(this.ui.warning);
    };

    return adminSimpleApp;

  })();
  return adminSimpleApp.init();
})($, _, EJS);

//# sourceMappingURL=admin-simple-app.js.map
